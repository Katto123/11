<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>富文本编辑器</title>
  <style>
    /* .edit[contenteditable]:empty:before {
      content: attr(placeholder);
      color: #cccccc;
    }

    .edit[contenteditable]:focus {
      content: none;
    } */

    .float {
      float: left;
      overflow: hidden;
      border-radius: 10px;
      /* padding: 5px;
      margin: 5px; */
      width: 100%;
      /* background-color: aquamarine; */
    }

    /* img {
      position: relative;
    } */

    .results {
      /* background-color: aqua; */
      min-width: 200px;
      height: auto;
      text-align: center;
      box-sizing: border-box;
    }

    #tp {
      border: 2px solid #FFFFFF;

    }

    #tp:hover {
      border: 2px solid #33FFFF;
    }


    #file_input {
      display: none;
    }

    .zs {
      outline: none;
      /* user-modify: read-write; */
      min-width: 20%;
      max-width: 80%;
      min-height: 17px;
      /* background: none;
      outline: none;
      border: 0px; */
      /* position: absolute; */
      display: inline-block;
      text-align: center;
      font-size: 12px;
      color: #999;
      border-bottom: 1px solid rgba(240, 240, 240, 1);

    }

    .zs:after {
      content: attr(dataBefore);
      color: #c0c0c0;
    }

    blockquote::before {
      content: "";
      width: 25px;
      height: 26px;
      display: block;
      position: absolute;
      margin-left: -39px;
      margin-top: -2px;
      background-image: url(./w.png);
      background-size: 100% 100%;
    }

    /* 
      .delete {
        width: 200px;
        height: 200px;
        position: absolute;
        text-align: center;
        line-height: 200px;
        z-index: 10;
        font-size: 30px;
        background-color: rgba(255, 255, 255, 0.8);
        color: #777;
        opacity: 0;
        transition-duration: 0.7s;
        -webkit-transition-duration: 0.7s;
      } */

    /* .delete:hover {
        cursor: pointer;
        opacity: 1;
      } */
  </style>
</head>

<body>
  <center>
    <h2 style="margin: auto">富文本编辑器</h2>
  </center>
  <hr />
  <div id="toolbar" style="
        width: 80%;
        margin: auto;
        border: 2px solid gray;
        padding: 5px;
        overflow: auto;
        font-family: 'Courier New', Courier, monospace;
      ">
    <input type="button" name="bold" value="加粗" class="bold" />
    <input type="button" name="italic" value="斜体" class="italic" />
    <input type="button" name="underline" value="下划线" class="decotation" />
    <input type="button" name="insertHorizontalRule" value="水平线" class="insertHorizontalRule" />
    大小
    <select name="fontSize" class="font">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
    </select>
    <!-- 图片
        <select name="insertImage">
            <option value="">请选择图片</option>
            <option value="timg.jpg">timg.jpg</option>
            <option value="timg1.jpg">timg1.jpg</option>
            <option value="timg2.jpg">timg2.jpg</option>
            <option value="timg3.jpg">timg3.jpg</option>
            <option value="timg4.jpg">timg4.jpg</option>
        </select> -->
    <!-- <input type="button" name="insertImage" value='插入图片(未完成,可粘贴)' class="insImg"> -->
    <input type="button" name="selectAll" value="全选" class="selectAll" />
    <input type="button" name="undo" value="撤销" class="undo" />
    <input type="button" name="justifyLeft" value="居左" class="justifyLeft" />
    <input type="button" name="justifyCenter" value="居中" class="justifyCenter" />
    <input type="button" name="justifyRight" value="居右" class="justifyRight" />
    <input type="button" name="insertOrderedList" value="有序列表" class="insertOrderedList" />
    <input type="button" name="insertUnorderedList" value="无序列表" class="insertUnorderedList" />
    <input type="button" name="strikeThrough" value="划掉" class="strikeThrough" />
    <input type="button" name="indent" value="引用" class="indent" />
    <button id="add" onclick="add1()">图片</button>
    <!-- <input type="button" id="add" onclick="add1()" value="图片" /> -->
    <!-- <button onclick="clickInsert()">点击插入一个按钮</button> -->
    <button id="yy" aria-pressed="false">引用</button>
    <button id="qxyy" aria-pressed="false">取消引用</button>
    <input type="file" id="file_input" />
  </div>

  <!-- onblur="blurEdit()"  onclick="hqjd()"  -->
  <div id="edit" onblur="blurEdit()" style="
        width: 80%;
        height: 700PX;
        margin: auto;
        border: 2px solid gray;
        padding: 5px;
        overflow: auto;
      " contenteditable="true" spellcheck="false">
    <!-- <p contenteditable="false">sdffffffffffffffffffffffffff</p> -->
    <p> <br></p>
    <!-- <blockquote><p>12121</p></blockquote> -->
  </div>

  <!-- <button id="save" style="width:300px;height:30px;margin:auto;margin-top:30px;
    background-color: green;border:1px solid green;display: block;color: white;font-family:'Courier New', Courier, monospace;
    font-weight: 500;font-size: 20px;">点 击</button> -->

  <div id="shade" style="
        width: 100%;
        height: 100%;
        background-color: white;
        opacity: 0.5;
        position: absolute;
        z-index: 5;
        display: none;
        left: 0;
        top: 0;
      "></div>
  <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
  <script>


    // var dianji = 0
    // var p = document.getElementById('p');
    // p.addEventListener('click', function(){
    //   dianji = 1;
    //   yy() 
    // })
    // var yy = document.getElementById('yy');
    // yy.addEventListener('click', function(){
    //  console.log(dianji);

    // })


    var num = 0;

    var yy = document.getElementById('yy')
    yy.addEventListener('click', function () {
      if (num = 0) {
        num === 1
      } else (num = 1) => {
        num === 0
      }
      console.log(num);
      $(document).ready(function () {
        var ch = $("#edit").find("p");
        for (var i = 0; i < ch.length; i++) {
          console.log(ch[i]);
          ch[i].onclick = wd1
        }
      })

    })




    function wd1() {
      if (num = 1) {
        $(this).wrap('<blockquote></blockquote>');
        cp()
        console.log(num);
      } else {
        jies = this
        var parent = jies.parentElement; // 获取result的父元素
        parent.removeChild(jies); // 删除result 元素
      }
    }


    // 取消引用


    var c = 0;

    var qxyy = document.getElementById('qxyy')
    qxyy.addEventListener('click', function () {
      if (c = 0) {
        c === 1
      } else (c = 1) => {
        c === 0
      }
      console.log(c);
      $(document).ready(function () {
        var ch = $("#edit").find("p");
        for (var i = 0; i < ch.length; i++) {
          console.log(ch[i]);
          ch[i].onclick = wd2
        }
      })

    })




    function wd2() {
      if (c = 1) {
        const divElement = document.querySelector('blockquote')
        const h1Element = document.querySelector('p')
        divElement.parentNode.insertBefore(h1Element, divElement.nextElementSibling)
        divElement.remove()
      }
    }







    function yy111() {
      yiny()
    }

    function yiny() {
      // console.log(dianji);
      $(document).ready(function () {
        var ch = $("#edit").find("p");
        for (var i = 0; i < ch.length; i++) {
          console.log(ch[i]);
          ch[i].onclick = wd
        }
      })
    }
    function wd() {
      $(this).wrap('<blockquote></blockquote>');
      cp()
    }


    // 点击编辑框让他变成可编辑状态（好像没有什么影响）
    function hqjd() {
      const edit2 = document.getElementById('edit')
      edit2.contentEditable = true

      let results = document.getElementById("cs")
      for (let o = 0; o < results.length; o++) {

        results[o].onclick = tpc
      };

    }



    // 图片不被点击颜色变换回来
    function tpc() {
      this.style.border = "2px solid #FFFFFF"
    }

    // 点击生成p标签
    function cp() {
      const edit1 = document.getElementById('edit')
      var p = document.createElement('p');
      p.innerHTML = "<br>"
      edit1.appendChild(p);
    }


    //  图片注释的回车事件
    // function hc() {
    //   document.onkeydown = function (e) {
    //     var ev = (typeof event != 'undefined') ? window.event : e;
    //     if (ev.keyCode == 13) {
    //       return false;
    //       console.log("回车");
    //     }
    //   }
    // }

    // // 大标签获取焦点 屏蔽回车
    // function hdjd() {
    //   if(document.getElementById("cs").contentEditable = true){
    //     document.onkeypress = function () {
    //     if (event.keyCode == 13) {
    //       console.log("回车");
    //       return false;
    //     }

    //   }
    //   }


    //   console.log("获取焦点");
    // }
    // // 大标签失去焦点 取消屏蔽回车
    // function sqjd() {
    //   document.onkeypress = function () {
    //     if (event.keyCode == 13) {
    //       console.log("取消回车");
    //       return true;
    //     }

    //   }
    // }

    // 鼠标移出大框事件
    function imgtpyr() {
      const cs2 = document.getElementsByClassName('results')
      for (let k = 0; k < cs2.length; k++) {
        cs2[k].onclick = kbj  // 给每一个图片大框添加点击事件
      };

      let TPYR = document.getElementsByTagName("img");
      for (let i = 0; i < TPYR.length; i++) {

        TPYR[i].onclick = kbjj
      };

    }

    function kbj() {
      editss = document.getElementById('edit')
      editss.contentEditable = true

      // this.style.border='2px solid #FFFFFF'


    }
    function kbjj() {


      this.style.border = '2px solid #FFFFFF'


    }


    // 鼠标移入图片
    function tpyr() {

      let TPYR = document.getElementsByTagName("img");
      for (let i = 0; i < TPYR.length; i++) {
        add2()
        TPYR[i].onclick = tpd
      };
    }


    // 图片移出
    function tpyc() {
      let results = document.getElementById("cs")
      for (let o = 0; o < results.length; o++) {

        cz = results[o]
        cz.contenteditable = true
        console.log("区域变成可编辑");
      };
    }

    //  function  tpdj(){
    //   console.log("点击图片");
    //   edit = document.getElementById('edit')
    //     edit.contenteditable = false
    //  } 



    // // 图片点击
    // function tpdj() {
    //   // const edit = document.getElementById('edit')
    //   // console.log(edit);
    //   // edit.contentEditable = false  // 点击图片的时候 编辑框失去焦点  (但是会有一个问题 导致删除图片后没有焦点  暂时不添加这个功能)


    //   // let result = document.getElementsByTagName("result");
    //   // console.log(result);
    //   let TPYC = document.getElementsByTagName("img");
    //   // var parent = result.parentElement;
    //   // console.log(parent);
    //   for (let i = 0; i < TPYC.length; i++) {
    //     TPYC[i].onclick = tpd
    //     document.onkeydown = add2;  // 键盘事件
    //   };

    // }
    //     function add2(event) {
    //   let keycode = event.keyCode;
    //   if (keycode == 32) {
    //     alert("空格键被按下了")
    //   }
    // }

    var jies = ""
    function add2() {

      document.addEventListener('keydown', (e) => {
        // console.log(e.target);
        if (e.keyCode === 8) {  // 监听删除按键
          // let result = document.getElementsByClassName("result")[0]; //获取result元素
          let result = jies.parentElement
          console.log(result);

          // var fj = this.parentElement
          // console.log(fj);
          var parent = result.parentElement; // 获取result的父元素
          parent.removeChild(result); // 删除result 元素
          console.log(111);
        }
        return false
      })



    }
    function tpd() {  // 鼠标在移入情况下点击图片
      editss = document.getElementById('edit')
      console.log(editss);
      editss.contentEditable = false


      jies = this
      this.style.border = "2px solid #33CCFF"

    }

    // 鼠标移入并且点击图片注释事件
    function yrzs() {
      let MYP1 = document.getElementsByTagName("figcaption");
      for (let w = 0; w < MYP1.length; w++) {
        MYP1[w].onclick = xs

      };
    }



    // 鼠标移入图片注释的点击事件
    function xs() {
      let d = document.getElementsByTagName("button");
      for (let f = 0; f < d.length; f++) {
        d[f].disabled = true;  // 禁用编辑器按钮
      };
      let h = document.getElementsByTagName("select");
      for (let y = 0; y < h.length; h++) {
        h[y].disabled = true;  // 禁用编辑器按钮
      };
      // .disabled = false
      let a = document.getElementsByTagName("input")
      for (let i = 0; i < a.length; i++) {
        a[i].disabled = true;  // 禁用编辑器按钮
      };
      document.getElementById("myP").contentEditable = true; // (暂时不用)   
      if (document.getElementById("myP").contentEditable = true) {
        hc()  // 注释屏蔽回车功能
      }
      this.setAttribute('dataBefore', ' ');// 修改注释默认提示
    }

    // 编辑的时候屏蔽回车事件
    function hc() {
      document.onkeypress = function () {
        if (event.keyCode == 13) {
          console.log("回车");
          return false; //可以控制是否屏蔽
        }

      }
    }
    // 限制大的编辑框不屏蔽回车事件
    function qxhc() {
      document.onkeypress = function () {
        if (event.keyCode == 13) {
          console.log("取消回车");
          return true;
        }

      }
    }

    // 图片注释失去焦点事件



    // function cx() {
    //   console.log("显示提示");
    //   this.setAttribute('dataBefore', ' 在此输入图片注释');// 修改注释默认提示
    // }

    function cc() {
      let MYP = document.getElementsByTagName("figcaption");
      for (let i = 0; i < MYP.length; i++) {
        let dg = MYP[i]
        let nr = dg.innerHTML
        console.log(nr);
        if (nr === "") {
          // var cx = dg.querySelector('.zs')
          dg.setAttribute('dataBefore', '在此输入图片注释 '); // 显示注释默认提示
        }

      };





      let d1 = document.getElementsByTagName("button");
      for (let f1 = 0; f1 < d1.length; f1++) {
        d1[f1].disabled = false;  // 可以使用编辑器按钮
      };
      let h1 = document.getElementsByTagName("select");
      for (let y1 = 0; y1 < h1.length; h1++) {
        h1[y1].disabled = false; // 可以使用编辑器按钮
      };
      // .disabled = false
      let a1 = document.getElementsByTagName("input")
      for (let i1 = 0; i1 < a1.length; i1++) {
        a1[i1].disabled = false; // 可以使用编辑器按钮
      };

      qxhc()
      // document.getElementById("myP").contentEditable = false;// （不用）
    }
    // // 把按钮插入在光标后面
    // let position = ''
    // function blurEdit() {
    //   position = window.getSelection().getRangeAt(0)
    // }
    // function clickInsert() {
    //   if (position === '') {
    //     // 如果div没有光标，则在div内容末尾插入
    //     const div = document.getElementById('inputContent')
    //     div.focus()
    //     const range = window.getSelection()
    //     range.selectAllChildren(div)
    //     range.collapseToEnd()
    //     position = window.getSelection().getRangeAt(0)
    //   }
    //   // 创建一个元素
    //   const span = document.createElement('span')
    //   // 插入的按钮不可编辑，设置contenteditable为false
    //   span.innerHTML = '<figure class="result" contenteditable="false"  ><img src="' +
    //         this.result +
    //         '" alt=""/><br ><figcaption contenteditable="true"  class="zs" >在此输入图片注释</figcaption> </figure><br >'
    //   // 将按钮插入
    //   position.insertNode(span)
    // }




    // var sel = window.getSelection();
    // document.onmouseup = function () {
    //   var a = sel.anchorOffset
    //   console.log(sel.anchorNode);    //起点所在的文本节点
    //   console.log(a);  //起点在该节点中的位置   
    // }
    var input = document.getElementById('file_input');
    var onInput = document.getElementById('file_input');
    var oAdd = document.getElementById('add');
    var dataArr = []; // 储存所选图片的结果(文件名和base64数据)
    var fd;
    var result;
    (function () {
      // 富文本编辑器类 类的构造函数
      class Editor {
        constructor() {
          this.bindElem();
        }

        bindElem() {
          var toolbar = document.getElementById('toolbar');
          var bs = toolbar.querySelectorAll('input,select');
          for (var i = 0; i < bs.length; i++) {
            if (bs[i].tagName.toLowerCase() == 'select') {
              bs[i].onchange = function () {
                document.execCommand(this.name, true, this.value);
              };
            } else if (bs[i].tagName.toLowerCase() == 'input') {
              this.action(bs[i], bs[i].name);
            }
          }
        }

        action(obj, attr) {
          obj.onclick = function () {
            document.execCommand(attr, true);
          };
        }
      }

      new Editor();
    })();

    // 监听粘贴事件
    //   document.querySelector('#edit').addEventListener('paste', function (e) {
    //     // 判断剪切板是否有内容
    //     if (!(e.clipboardData && e.clipboardData.items)) {
    //       return;
    //     }

    //     for (var i = 0, len = e.clipboardData.items.length; i < len; i++) {
    //       var item = e.clipboardData.items[i];
    //       if (item.kind == 'file') {
    //         var blob = item.getAsFile();
    //         var reader = new FileReader();
    //         var imgs = new Image();
    //         imgs.file = blob;
    //         reader.onload = (function (aImg) {
    //           return function (e) {
    //             aImg.src = e.target.result;
    //           };
    //         })(imgs);
    //         reader.readAsDataURL(blob);
    //         document.querySelector('#edit').appendChild(imgs);
    //       }
    //     }
    //   });

    //   document.getElementById('save').onclick = function () {
    //     alert(document.getElementById('edit').innerHTML);
    //   };

    //   document.querySelector('.insImg').onclick = function () {
    //     document.getElementById('shade').style.display = 'block';
    //     var div = document.createElement('div');
    //     div.style.cssText =
    //       'width:300px;height:50px;border:1px solid #000;background-color:white;' +
    //       'text-align:center;line-height:50px;' +
    //       'position:absolute;z-index:9;left:0; top:0;right:0;bottom:0;margin:auto;';
    //     var input = document.createElement('input');
    //     input.type = 'file';
    //     div.appendChild(input);
    //     document.body.appendChild(div);
    //   };

    // new




    //判断是否支持FileReader
    if (typeof FileReader === 'undefined') {
      alert('抱歉，你的浏览器不支持 FileReader');
      input.setAttribute('disabled', 'disabled'); //添加属性，禁用input
    } else {
      //添加监听事件
      input.addEventListener('change', readFile, false); //默认值是false，冒泡传递;当值为true，捕获传递
    }
    let position = ''
    function blurEdit() {
      position = window.getSelection().getRangeAt(0)
    }

    function readFile() {

      if (position === '') {
        // 如果div没有光标，则在div内容末尾插入
        const div = document.getElementById('edit')
        div.focus()
        const range = window.getSelection()
        range.selectAllChildren(div)
        range.collapseToEnd()
        position = window.getSelection().getRangeAt(0)
      }



      fd = new FormData(); //FormData方式发送请求
      var iLen = this.files.length; //获取图片数量
      var index = 0;
      for (var i = 0; i < iLen; i++) {
        if (!input['value'].match(/.jpg|.gif|.png|.jpeg|.bmp/i)) {
          //判断上传文件格式
          return alert('上传的图片格式不正确，请重新选择');
        }
        var reader = new FileReader(); //创建FileReader对象
        reader.index = i;
        fd.append(i, this.files[i]); //可以通过fd.get(i)获取FormData()对应的值;
        reader.readAsDataURL(this.files[i]); //转成base64，并存在reader.result里
        reader.fileName = this.files[i].name;
        reader.onload = function (e) {
          //设置图片信息对象
          var imgMsg = {
            name: this.fileName, //获取文件名
            base64: this.result, //reader.readAsDataURL方法执行完后，base64数据储存在reader.result里
          };
          dataArr.push(imgMsg); //将图片信息对象存到数据数组中
          console.log(dataArr);
          result =
            '<figure class="results" id="cs"   onmouseout="imgtpyr()"   contenteditable="false" ><img id="tp" onmouseover="tpyr()"  onmouseout="tpyc()"  onclick="tpdj()" src="' +
            this.result +
            '" alt=""/><br><figcaption  contenteditable="true" dataBefore="在此输入图片注释 "   onclick="qq()" onblur="cc()"  onmouseover="yrzs()"  id="myP" class="zs" ></figcaption> </figure>';
          var div = document.createElement('div');
          // div.contenteditable = true
          div.innerHTML = result;
          div['className'] = 'result';
          div['index'] = index;
          console.log(div);


          // document.getElementById('edit').appendChild(div); //插入dom树

          position.insertNode(div)
          cp()
          // div.onclick = function () {
          //   this.remove(); // 在页面中删除该图片元素
          //   // delete dataArr[this.index]; // 删除dataArr对应的数据
          // };

          index++;

        };
      }
    }
    function add1() {
      onInput.value = ''; // 先将oInput值清空，否则选择图片与上次相同时change事件不会触发
      onInput.click();
    }

  </script>
</body>

</html>